<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ganesh Festival Contributions - Village</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Dancing+Script:700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', 'Roboto', 'Segoe UI', Arial, sans-serif;
      background: url('https://png.pngtree.com/png-clipart/20230810/original/pngtree-ganesh-chaturthi-festival-background-with-lord-ganesha-png-image_10696436.png') center top/cover no-repeat, linear-gradient(135deg, #fff8e1 0%, #fff3b0 50%, #ffe082 100%);
      /* Gradient: light saffron to pale yellow */
      margin: 0; padding: 0;
      min-height: 100vh;
      font-size: 14px;
    }
    .container {
      max-width: 1200px;
      width: 96vw;
      min-width: 320px;
      margin: 40px auto;
      background: linear-gradient(135deg, #fff8e1 0%, #fff3b0 100%);
      /* Gradient: light saffron to pale yellow */
      padding: 32px 32px 32px 32px;
      border-radius: 12px;
      box-shadow: 0 4px 16px #e6a13c33;
      border: 2px solid #e6a13c;
      transition: width 0.3s;
    }
    @media (max-width: 1300px) {
      .container {
        max-width: 98vw;
        padding: 16px;
      }
    }
    @media (max-width: 900px) {
      .container {
        max-width: 99vw;
        padding: 8px;
      }
      table, th, td {
        font-size: 0.98em;
      }
    }
    h1 {
      color: #b36b00;
      text-align: center;
      font-family: 'Georgia', serif;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    h2 {
      color: #ff9800;
      margin-top: 32px;
    }
    h1, h2, .gallery-heading {
      font-family: 'Dancing Script', 'Pacifico', cursive, 'Poppins', 'Roboto', Arial, sans-serif !important;
      letter-spacing: 1px;
    }
    .ganesh {
      display: block;
      margin: 0 auto 16px auto;
      width: 80px;
      filter: drop-shadow(0 2px 8px #ffb30088);
    }
    .ganesh-large {
      display: block;
      margin: 0 auto 24px auto;
      width: 140px;
      filter: drop-shadow(0 4px 16px #ffb30088);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
      background: #fffde7;
    }
    th, td {
      border: 1px solid #ffe082;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #ffe082;
      color: #e65100;
    }
    .summary {
      background: #fffde7;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 24px;
      border: 1px solid #ffe082;
      font-size: 1em;
      font-weight: bold;
    }
    label, th, .gallery-label, .gallery-heading, .gallery-upload-label {
      font-weight: bold !important;
    }
    td, .login-error, .summary, .data-table td, #summary, #gallery-upload-msg, #gallery-grid, #events-list, #dashboard-section, #events-section, #gallery-section, #main-content, #login-section, #signup-section {
      font-weight: bold;
    }
    .credit { color: green; }
    .debt { color: red; }
    .login-box {
      max-width: 350px;
      margin: 80px auto 0 auto;
      background: linear-gradient(135deg, #fff8e1 0%, #fff3b0 100%) url('https://png.pngtree.com/png-clipart/20230810/original/pngtree-ganesh-chaturthi-festival-background-with-lord-ganesha-png-image_10696436.png') center 60px/cover no-repeat;
      border: 2px solid #e6a13c;
      border-radius: 18px;
      box-shadow: 0 6px 32px #e6a13c44, 0 1.5px 6px #ffb30033;
      padding: 40px 32px 32px 32px;
      text-align: center;
      position: relative;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .login-box form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .login-box .input-icon-group {
      max-width: 240px;
      margin-left: auto;
      margin-right: auto;
    }
    .login-box .input-icon-group input {
      width: 100%;
      min-width: 0;
      max-width: 240px;
      box-sizing: border-box;
    }
    .login-box input {
      width: 100%;
      padding: 10px;
      margin: 0 0 8px 0;
      border: 1px solid #ffe082;
      border-radius: 7px;
      font-size: 0.98em;
      background: #fffde7;
      box-shadow: 0 1px 3px #ffe08233 inset;
    }
    .login-box button[type="submit"] {
      background: linear-gradient(90deg, #ff9800 0%, #ffd54f 100%);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 10px 0;
      font-size: 1.08em;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 2px 8px #e6a13c33;
      letter-spacing: 0.5px;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.18s cubic-bezier(.4,2,.6,1), filter 0.18s;
      max-width: 240px;
      width: 100%;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .login-box button[type="submit"]:hover {
      background: linear-gradient(90deg, #ffd54f 0%, #ff9800 100%);
      color: #fffde7;
      box-shadow: 0 4px 16px #e6a13c55;
      filter: brightness(1.08) drop-shadow(0 0 8px #ffe082cc);
      transform: scale(1.06) translateY(-2px);
    }
    #logout-btn, #download-report-btn, #download-gallery-btn, #show-dashboard, #show-events, #gallery-upload-form button {
      background: linear-gradient(90deg, #ffd54f 0%, #ffb300 100%);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 24px;
      font-size: 1em;
      cursor: pointer;
      margin-bottom: 18px;
      box-shadow: 0 2px 6px #e6a13c33;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s, transform 0.18s cubic-bezier(.4,2,.6,1), filter 0.18s;
    }
    #logout-btn:hover, #download-report-btn:hover, #download-gallery-btn:hover, #show-dashboard:hover, #show-events:hover, #gallery-upload-form button:hover {
      background: linear-gradient(90deg, #ffb300 0%, #ffd54f 100%);
      color: #fffde7;
      box-shadow: 0 4px 12px #e6a13c55;
      filter: brightness(1.08) drop-shadow(0 0 8px #ffe082cc);
      transform: scale(1.06) translateY(-2px);
    }
    .scroll-blessing-message {
      position: absolute;
      top: -38px;
      left: 0;
      width: 100%;
      font-size: 1.1em;
      color: #b36b00;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      z-index: 20;
      text-shadow: 1px 1px 6px #ffe082;
      background: #fffbe7cc;
      padding: 6px 0;
      border-radius: 8px 8px 0 0;
      animation: scroll-left-right-blessing 18s linear infinite;
    }
    @keyframes scroll-left-right-blessing {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .input-icon-group {
      position: relative;
      width: 100%;
      margin-bottom: 8px;
    }
    .input-icon-group input {
      padding-left: 36px !important;
    }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #e6a13c;
      font-size: 1.1em;
      pointer-events: none;
    }
    /* Floating diya/flower animation */
    .floating-bg-anim {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .floating-obj {
      position: absolute;
      width: 36px; height: 36px;
      opacity: 0.18;
      animation: float-diyaa 16s linear infinite;
      will-change: transform;
    }
    .floating-obj.flower {
      width: 32px; height: 32px;
      opacity: 0.18;
      animation: float-flower 18s linear infinite;
    }
    @keyframes float-diyaa {
      0% { transform: translateY(110vh) scale(1) rotate(0deg); }
      100% { transform: translateY(-10vh) scale(1.1) rotate(18deg); }
    }
    @keyframes float-flower {
      0% { transform: translateY(120vh) scale(0.95) rotate(0deg); }
      100% { transform: translateY(-10vh) scale(1.05) rotate(-24deg); }
    }
  </style>
</head>
<body>
  <div id="session-warning" style="display:none;position:fixed;top:0;left:0;width:100%;background:#ffecb3;color:#b36b00;text-align:center;padding:10px 0;font-size:1.1em;z-index:9999;font-weight:bold;box-shadow:0 2px 8px #b36b0033;"></div>
  <div id="login-section" class="login-box" style="display:block;position:relative;">
    <div class="scroll-blessing-message">
     Happy VINAYAKA Chaturdhi
    </div>
    <img class="ganesh" src="https://cdn-icons-png.flaticon.com/512/616/616494.png" alt="Ganesh Icon">
    <h2>Login to Ganesh Festival Portal - M.D Puttur village </h2>
    <form id="login-form">
      <div class="input-icon-group">
        <span class="input-icon"><i class="fa fa-user"></i></span>
        <input type="text" id="login-username" placeholder="Username" required><br>
      </div>
      <div class="input-icon-group">
        <span class="input-icon"><i class="fa fa-lock"></i></span>
        <input type="password" id="login-password" placeholder="Password" required><br>
      </div>
      <button type="submit">Login</button>
      <div class="login-error" id="login-error"></div>
    </form>
    <div style="margin-top:18px;">
      <span>New user? <a href="#" id="show-signup">Sign up</a></span>
    </div>
    <div style="position:absolute;left:-410px;top:30px;width:340px;background:#fffde7;border:2px solid #ff9800;border-radius:12px;padding:20px 20px 16px 20px;box-shadow:0 2px 12px #ffb30055;">
      <div style="font-size:1.18em;font-weight:bold;color:#d84315;margin-bottom:10px;letter-spacing:1px;"><span style='color:#d84315;font-weight:bold;'>Note:</span></div>
      <div style="font-size:1.08em;font-weight:bold;color:#b36b00;margin-bottom:4px;">This application helps you track Ganesh festival donations, expenses, and event updates for our village.</div>
      <div style="font-size:1.08em;font-weight:bold;color:#b36b00;">Easily manage contributors, expenses and download reports for full transparency.</div>
    </div>
  </div>
  <div id="signup-section" class="login-box" style="display:none;">
    <img class="ganesh" src="https://cdn-icons-png.flaticon.com/512/616/616494.png" alt="Ganesh Icon">
    <h2>Sign Up</h2>
    <form id="signup-form">
  <label for="signup-username" style="float:left;width:100%;text-align:left;margin-bottom:2px;"><b>Username <span style="color:red">*</span></b></label>
  <input type="text" id="signup-username" placeholder="Username" required><br>
  <label for="signup-password" style="float:left;width:100%;text-align:left;margin-bottom:2px;"><b>Create Password <span style="color:red">*</span></b></label>
  <input type="password" id="signup-password" placeholder="Create password" required><br>
  <label for="signup-confirm-password" style="float:left;width:100%;text-align:left;margin-bottom:2px;"><b>Confirm Password <span style="color:red">*</span></b></label>
  <input type="password" id="signup-confirm-password" placeholder="Confirm password" required><br>
  <label for="signup-mobno" style="float:left;width:100%;text-align:left;margin-bottom:2px;"><b>Mobile Number (optional)</b></label>
  <input type="text" id="signup-mobno" placeholder="Mobile number" pattern="[0-9]{10}" maxlength="10" style="width:100%;margin-bottom:8px;">
  <button type="submit">Create Account</button>
  <div class="login-error" id="signup-error"></div>
    </form>
    <div style="margin-top:18px;">
      <span>Already have an account? <a href="#" id="show-login">Login</a></span>
    </div>
  </div>
  <div class="container" id="main-content" style="display:none;">
  <div style="clear:both;"></div>
  <!-- ...existing dashboard and events sections... -->
  <div id="gallery-section" style="margin-top:36px;">
  <h1 class="gallery-heading"><b>Gallery - Images & Videos</b></h1>
    <form id="gallery-upload-form" style="margin-bottom:18px;">
  <label class="gallery-upload-label"><b>Upload Images/Videos:</b></label>
  <input type="file" id="gallery-files" accept="image/*,video/*" multiple required>
  <button type="submit"><b>Upload</b></button>
  <span id="gallery-upload-msg" style="color:green;margin-left:12px;"></span>
    </form>
  <button id="download-gallery-btn" style="background:#b36b00;color:#fff;border:none;border-radius:5px;padding:8px 24px;font-size:1em;cursor:pointer;margin-bottom:18px;"><b>Download All</b></button>
    <div id="gallery-grid" style="display:flex;flex-wrap:wrap;gap:18px;"></div>
  </div>
  <button id="logout-btn" style="float:right;background:#ffb300;color:#fff;border:none;border-radius:5px;padding:6px 18px;font-size:1em;cursor:pointer;">Logout</button>
  <button id="show-dashboard" style="float:left;background:#fff3e0;color:#b36b00;border:1px solid #ffb300;border-radius:5px;padding:6px 18px;font-size:1em;cursor:pointer;display:none;">Dashboard</button>
  <button id="show-events" style="float:left;background:#fff3e0;color:#b36b00;border:1px solid #ffb300;border-radius:5px;padding:6px 18px;font-size:1em;cursor:pointer;">Events Live Updates</button>
    <div style="clear:both;"></div>
    <div id="dashboard-section">
      <img class="ganesh-large" src="https://cdn-icons-png.flaticon.com/512/616/616494.png" alt="Ganesh Icon">
  <h1>Ganesh Festival - Donors & Expenses</h1>
  <div class="summary" id="summary"></div>
  <button id="download-report-btn" style="background:#b36b00;color:#fff;border:none;border-radius:5px;padding:8px 24px;font-size:1em;cursor:pointer;margin-bottom:18px;">Download PDF Report</button>
      <h2>Donors</h2>
      <form id="donor-form" style="margin-bottom:16px;display:none;">
        <input type="text" id="donor-name" placeholder="Name" required>
        <input type="number" id="donor-amount" placeholder="Amount" required min="1">
        <button type="submit">Add Donor</button>
      </form>
      <table id="donors-table">
        <thead>
          <tr><th>Name</th><th>Amount</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <h2>Expenses</h2>
      <form id="expense-form" style="margin-bottom:16px;display:none;">
        <input type="text" id="expense-item" placeholder="Item" required>
        <input type="text" id="expense-spentby" placeholder="Spent By" required>
        <input type="number" id="expense-amount" placeholder="Amount" required min="1">
        <button type="submit">Add Expense</button>
      </form>
      <table id="expenses-table">
        <thead>
          <tr><th>Item</th><th>Spent By</th><th>Amount</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="events-section" style="display:none;">
      <img class="ganesh-large" src="https://cdn-icons-png.flaticon.com/512/616/616494.png" alt="Ganesh Icon">
      <h1>Events Live Updates</h1>
      <form id="event-form" style="margin-bottom:16px;display:none;">
        <input type="text" id="event-title" placeholder="Event Title" required>
        <input type="text" id="event-desc" placeholder="Description" required>
        <input type="date" id="event-date" required>
        <input type="time" id="event-time" required>
        <button type="submit">Add Event Update</button>
      </form>
      <ul id="events-list" style="list-style:none;padding:0;"></ul>
    </div>
  </div>
  <div class="floating-bg-anim">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:8vw; animation-delay:0s; animation-duration:16s;">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:70vw; animation-delay:3s; animation-duration:19s;">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:40vw; animation-delay:7s; animation-duration:17s;">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:85vw; animation-delay:5s; animation-duration:20s;">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:25vw; animation-delay:2s; animation-duration:18s;">
      <img src="https://cdn-icons-png.flaticon.com/512/3043/3043812.png" class="floating-obj" style="left:55vw; animation-delay:6s; animation-duration:21s;">
      <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" class="floating-obj flower" style="left:15vw; animation-delay:4s; animation-duration:22s;">
      <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" class="floating-obj flower" style="left:60vw; animation-delay:8s; animation-duration:23s;">
      <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" class="floating-obj flower" style="left:35vw; animation-delay:10s; animation-duration:20s;">
      <img src="https://cdn-icons-png.flaticon.com/512/616/616554.png" class="floating-obj flower" style="left:80vw; animation-delay:12s; animation-duration:25s;">
    </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script>
    // --- Gallery Logic ---
    let galleryItems = JSON.parse(localStorage.getItem('galleryItems') || '[]');

    function renderGallery() {
      const grid = document.getElementById('gallery-grid');
      grid.innerHTML = '';
      if (galleryItems.length === 0) {
        grid.innerHTML = '<div style="color:#b36b00;font-size:1.1em;">No images or videos uploaded yet.</div>';
        return;
      }
      galleryItems.forEach((item, i) => {
        let wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.display = 'inline-block';
        let el;
        if (item.type.startsWith('image/')) {
          el = document.createElement('img');
          el.src = item.data;
          el.style.maxWidth = '180px';
          el.style.maxHeight = '140px';
          el.style.border = '2px solid #ffe082';
          el.style.borderRadius = '8px';
        } else if (item.type.startsWith('video/')) {
          el = document.createElement('video');
          el.src = item.data;
          el.controls = true;
          el.style.maxWidth = '180px';
          el.style.maxHeight = '140px';
          el.style.border = '2px solid #ffe082';
          el.style.borderRadius = '8px';
        }
        if (el) {
          wrapper.appendChild(el);
          // Delete button
          let delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.style.position = 'absolute';
          delBtn.style.top = '4px';
          delBtn.style.right = '4px';
          delBtn.style.background = '#ff5252';
          delBtn.style.color = '#fff';
          delBtn.style.border = 'none';
          delBtn.style.borderRadius = '4px';
          delBtn.style.padding = '2px 8px';
          delBtn.style.fontSize = '0.95em';
          delBtn.style.cursor = 'pointer';
          delBtn.onclick = function() {
            if (confirm('Delete this item from gallery?')) {
              galleryItems.splice(i, 1);
              localStorage.setItem('galleryItems', JSON.stringify(galleryItems));
              renderGallery();
            }
          };
          wrapper.appendChild(delBtn);
          grid.appendChild(wrapper);
        }
      });
    }


    // Always show gallery section below events
    renderGallery();

    // Download all gallery items as zip
    document.getElementById('download-gallery-btn').onclick = function() {
      if (!galleryItems.length) return alert('No gallery items to download.');
      // Use JSZip CDN
      if (typeof JSZip === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        script.onload = downloadGalleryZip;
        document.body.appendChild(script);
      } else {
        downloadGalleryZip();
      }
    };

    function downloadGalleryZip() {
      const zip = new JSZip();
      galleryItems.forEach((item, i) => {
        let ext = item.type.startsWith('image/') ? '.jpg' : item.type.startsWith('video/') ? '.mp4' : '';
        let base64 = item.data.split(',')[1];
        zip.file(item.name || ('file'+i+ext), base64, {base64:true});
      });
      zip.generateAsync({type:'blob'}).then(function(content) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = 'gallery.zip';
        a.click();
      });
    }

    // Gallery upload logic
    document.getElementById('gallery-upload-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const files = document.getElementById('gallery-files').files;
      if (!files.length) return;
      let loaded = 0;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        reader.onload = function(evt) {
          galleryItems.push({
            name: file.name,
            type: file.type,
            data: evt.target.result
          });
          loaded++;
          if (loaded === files.length) {
            localStorage.setItem('galleryItems', JSON.stringify(galleryItems));
            renderGallery();
            document.getElementById('gallery-upload-msg').textContent = 'Upload successful!';
            setTimeout(()=>{document.getElementById('gallery-upload-msg').textContent='';}, 2000);
            document.getElementById('gallery-upload-form').reset();
          }
        };
        reader.readAsDataURL(file);
      }
    });
    // --- Simple Routing for /login and /signup ---
    function showLoginSection(pushState = true) {
      document.getElementById('signup-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      if (pushState) history.pushState({page: 'login'}, '', '/login');
    }
    function showSignupSection(pushState = true) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('signup-section').style.display = 'block';
      if (pushState) history.pushState({page: 'signup'}, '', '/signup');
    }
    window.addEventListener('popstate', function(e) {
      if (location.pathname === '/signup') {
        showSignupSection(false);
      } else {
        showLoginSection(false);
      }
    });
    // On page load, show correct section (ignore trailing slash or hash)
    if (location.pathname.replace(/\/$/, '') === '/signup') {
      showSignupSection(false);
    } else {
      showLoginSection(false);
    }
    // --- Session Timeout Logic ---
    let sessionTimeoutId = null;
    let sessionWarningId = null;
    let sessionCountdown = 0;
  const SESSION_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutes
    const SESSION_WARNING_MS = 30 * 1000; // 30 seconds before timeout

    function startSessionTimeout() {
      clearSessionTimeout();
      sessionCountdown = Math.floor(SESSION_TIMEOUT_MS / 1000);
      // Start countdown display
      sessionWarningId = setInterval(() => {
        if (currentUser && sessionCountdown > 0) {
          sessionCountdown--;
          if (sessionCountdown <= 30) {
            showSessionWarning(sessionCountdown);
            if (sessionCountdown === 30) {
              // Alert user 30 seconds before logout
              alert('Session will expire in 30 seconds!');
            }
          } else {
            hideSessionWarning();
          }
        }
      }, 1000);
      // Set actual timeout
      sessionTimeoutId = setTimeout(() => {
        handleSessionTimeout();
      }, SESSION_TIMEOUT_MS);
    }

    function clearSessionTimeout() {
      if (sessionTimeoutId) {
        clearTimeout(sessionTimeoutId);
        sessionTimeoutId = null;
      }
      if (sessionWarningId) {
        clearInterval(sessionWarningId);
        sessionWarningId = null;
      }
      hideSessionWarning();
    }

    function handleSessionTimeout() {
      currentUser = null;
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('signup-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('login-form').reset();
      document.getElementById('login-error').textContent = 'Session timed out. Please login again.';
      hideSessionWarning();
    }

    function showSessionWarning(secondsLeft) {
      const bar = document.getElementById('session-warning');
      bar.style.display = 'block';
      bar.textContent = `Session will close in ${secondsLeft} second${secondsLeft!==1?'s':''}. Please save your work.`;
    }
    function hideSessionWarning() {
      const bar = document.getElementById('session-warning');
      bar.style.display = 'none';
      bar.style.textAlign = 'center';
      bar.style.padding = '10px 0';
      bar.style.fontSize = '1.1em';
      bar.style.zIndex = '9999';
      bar.style.fontWeight = 'bold';
      bar.style.boxShadow = '0 2px 8px #b36b0033';
      bar.style.borderRadius = '4px';
      bar.style.backgroundColor = '#fffbe7cc';
      bar.style.color = '#b36b00';
    }

    // Reset session timer on user activity
    function resetSessionOnActivity() {
      if (currentUser) startSessionTimeout();
    }
    ['click','keydown','mousemove','scroll','touchstart'].forEach(evt => {
      window.addEventListener(evt, resetSessionOnActivity, true);
    });
    // Download PDF Report (tabular format)
    document.getElementById('download-report-btn').onclick = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 15;
      doc.setFontSize(18);
      doc.text('M.D Puttur Ganesh festival contribution', 105, y, { align: 'center' });
      y += 10;
      doc.setFontSize(13);
      // Donors Table
      doc.text('Donors', 14, y);
      y += 4;
      if (donors.length > 0) {
        doc.autoTable({
          startY: y,
          head: [['Name', 'Amount']],
          body: donors.map(d => [d.name, d.amount.toLocaleString('en-IN')]),
          theme: 'grid',
          headStyles: { fillColor: [255, 224, 178], textColor: [179, 107, 0] },
          bodyStyles: { textColor: [44, 44, 44] },
          margin: { left: 14, right: 14 },
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.setFontSize(11);
        doc.text('No donors.', 18, y + 6);
        y += 14;
      }
      // Expenses Table
      doc.setFontSize(13);
      doc.text('Expenses', 14, y);
      y += 4;
      if (expenses.length > 0) {
        doc.autoTable({
          startY: y,
          head: [['Item', 'Spent By', 'Amount']],
          body: expenses.map(e => [e.item, e.spentBy, e.amount.toLocaleString('en-IN')]),
          theme: 'grid',
          headStyles: { fillColor: [255, 224, 178], textColor: [179, 107, 0] },
          bodyStyles: { textColor: [44, 44, 44] },
          margin: { left: 14, right: 14 },
        });
        y = doc.lastAutoTable.finalY + 8;
      } else {
        doc.setFontSize(11);
        doc.text('No expenses.', 18, y + 6);
        y += 14;
      }
      // Summary Table
      const totalDonated = donors.reduce((sum, d) => sum + d.amount, 0);
      const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
      const balance = totalDonated - totalSpent;
      doc.setFontSize(13);
      doc.autoTable({
        startY: y,
        head: [['Total Donated', 'Total Spent', 'Balance']],
        body: [[
          totalDonated.toLocaleString('en-IN'),
          totalSpent.toLocaleString('en-IN'),
          balance.toLocaleString('en-IN')
        ]],
        theme: 'grid',
        headStyles: { fillColor: [255, 224, 178], textColor: [179, 107, 0] },
        bodyStyles: { textColor: [44, 44, 44], fontStyle: 'bold' },
        margin: { left: 14, right: 14 },
      });
      doc.save('ganesh_festival_report.pdf');
    };
  // Editable data
  let donors = JSON.parse(localStorage.getItem('donors') || '[]');
  let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
  let events = JSON.parse(localStorage.getItem('events') || '[]');

  function saveAll() {
    localStorage.setItem('donors', JSON.stringify(donors));
    localStorage.setItem('expenses', JSON.stringify(expenses));
    localStorage.setItem('events', JSON.stringify(events));
  }
    // Navigation between dashboard and events
    document.getElementById('show-events').onclick = function() {
      document.getElementById('dashboard-section').style.display = 'none';
      document.getElementById('events-section').style.display = 'block';
      document.getElementById('show-events').style.display = 'none';
      document.getElementById('show-dashboard').style.display = 'inline-block';
      renderEvents();
    };
    document.getElementById('show-dashboard').onclick = function() {
      document.getElementById('dashboard-section').style.display = 'block';
      document.getElementById('events-section').style.display = 'none';
      document.getElementById('show-events').style.display = 'inline-block';
      document.getElementById('show-dashboard').style.display = 'none';
    };

    // Add event
    document.getElementById('event-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const title = document.getElementById('event-title').value.trim();
      const desc = document.getElementById('event-desc').value.trim();
      const date = document.getElementById('event-date').value;
      const time = document.getElementById('event-time').value;
      if (title && desc && date && time) {
        events.unshift({ title, desc, date, time });
        renderEvents();
        this.reset();
      }
    });

    function renderEvents() {
      const list = document.getElementById('events-list');
      list.innerHTML = '';
      events.forEach((ev, i) => {
        const li = document.createElement('li');
        li.style.background = '#fffde7';
        li.style.marginBottom = '12px';
        li.style.padding = '12px 16px';
        li.style.borderRadius = '8px';
        li.style.border = '1px solid #ffe082';
        li.innerHTML = `<b>${ev.title}</b> <span style='color:#b36b00;font-size:0.95em;'>(${ev.date} ${ev.time})</span><br><span>${ev.desc}</span> <button style='float:right;' onclick='deleteEvent(${i})'>Delete</button>`;
        list.appendChild(li);
      });
      saveAll();
    }

    // Delete event
    function deleteEvent(idx) {
      events.splice(idx, 1);
      renderEvents();
    }

    // In-memory users (default admin)
    let users = [{ username: 'admin', password: 'ganesh', isAdmin: true }];
    let currentUser = null;

    // Show/hide login/signup
    document.getElementById('show-signup').onclick = function() {
  showSignupSection();
    };
    document.getElementById('show-login').onclick = function() {
  showLoginSection();
    };

    // Signup (no OTP, mobile optional)
    document.getElementById('signup-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('signup-username').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm-password').value;
      const mobno = document.getElementById('signup-mobno').value.trim();
      if (!username || !password || !confirmPassword) {
        document.getElementById('signup-error').textContent = 'Please fill all required fields.';
        return;
      }
      if (users.some(u => u.username === username)) {
        document.getElementById('signup-error').textContent = 'Username already exists!';
        return;
      }
      if (password !== confirmPassword) {
        document.getElementById('signup-error').textContent = 'Passwords do not match!';
        return;
      }
      if (mobno && !/^\d{10}$/.test(mobno)) {
        document.getElementById('signup-error').textContent = 'Enter valid 10-digit mobile number or leave blank.';
        return;
      }
      users.push({
        username,
        password,
        mobno: mobno ? mobno : undefined,
        isAdmin: false
      });
      document.getElementById('signup-error').textContent = '';
      document.getElementById('signup-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('login-error').textContent = 'Account created! Please login.';
      this.reset();
    });

    // Login
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('signup-section').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        render();
  startSessionTimeout();
      } else {
        document.getElementById('login-error').textContent = 'Invalid username or password!';
      }
    });


    // Logout
    document.getElementById('logout-btn').onclick = function() {
      currentUser = null;
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('signup-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('login-form').reset();
      document.getElementById('login-error').textContent = 'Logout successfully!';
  clearSessionTimeout();
    };

  function render() {
      // Permissions: admin can edit, normal user is read-only
      const isAdmin = currentUser && currentUser.isAdmin;
      // Show/hide forms
      document.getElementById('donor-form').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('expense-form').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('event-form').style.display = isAdmin ? 'block' : 'none';

      // Render donors
      const donorsTable = document.querySelector('#donors-table tbody');
      donorsTable.innerHTML = '';
      donors.forEach((d, i) => {
        let row = document.createElement('tr');
        if (isAdmin && d.editing) {
          row.innerHTML = `
            <td><input type='text' value='${d.name}' id='edit-donor-name-${i}' style='width:90px'></td>
            <td><input type='number' value='${d.amount}' id='edit-donor-amount-${i}' style='width:70px'></td>
            <td>
              <button onclick="saveDonor(${i})">Save</button>
              <button onclick="cancelEditDonor(${i})">Cancel</button>
            </td>
          `;
        } else if (isAdmin) {
          row.innerHTML = `<td>${d.name}</td><td>₹${d.amount}</td><td><button onclick="editDonor(${i})">Edit</button> <button onclick="deleteDonor(${i})">Delete</button></td>`;
        } else {
          row.innerHTML = `<td>${d.name}</td><td>₹${d.amount}</td><td>-</td>`;
        }
        donorsTable.appendChild(row);
      });
      // Render expenses
      const expensesTable = document.querySelector('#expenses-table tbody');
      expensesTable.innerHTML = '';
      expenses.forEach((e, i) => {
        let row;
        if (isAdmin && e.editing) {
          row = document.createElement('tr');
          row.innerHTML = `
            <td><input type='text' value='${e.item}' id='edit-item-${i}' style='width:90px'></td>
            <td><input type='text' value='${e.spentBy}' id='edit-spentby-${i}' style='width:90px'></td>
            <td><input type='number' value='${e.amount}' id='edit-amount-${i}' style='width:70px' min='1'></td>
            <td>
              <button onclick="saveExpense(${i})">Save</button>
              <button onclick="cancelEditExpense(${i})">Cancel</button>
            </td>
          `;
        } else if (isAdmin) {
          row = document.createElement('tr');
          row.innerHTML = `<td>${e.item}</td><td>${e.spentBy}</td><td>₹${e.amount}</td><td><button onclick="editExpense(${i})">Edit</button> <button onclick="deleteExpense(${i})">Delete</button></td>`;
        } else {
          row = document.createElement('tr');
          row.innerHTML = `<td>${e.item}</td><td>${e.spentBy}</td><td>₹${e.amount}</td><td>-</td>`;
        }
        expensesTable.appendChild(row);
      });
      // Calculate totals
      const totalDonated = donors.reduce((sum, d) => sum + d.amount, 0);
      const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
      const balance = totalDonated - totalSpent;
      // Show summary
      document.getElementById('summary').innerHTML = `
        <b>Total Donated:</b> ₹${totalDonated} &nbsp; | &nbsp;
        <b>Total Spent:</b> ₹${totalSpent} &nbsp; | &nbsp;
        <b>Balance:</b> <span class="${balance >= 0 ? 'credit' : 'debt'}">₹${balance}</span>
      `;
      saveAll();
    }

    // Delete donor
    function deleteDonor(idx) {
      donors.splice(idx, 1);
      render();
    }

    // Edit expense
    function editExpense(idx) {
      expenses[idx].editing = true;
      render();
    }
    // Save expense
    function saveExpense(idx) {
      const item = document.getElementById('edit-item-' + idx).value.trim();
      const spentBy = document.getElementById('edit-spentby-' + idx).value.trim();
      const amount = parseInt(document.getElementById('edit-amount-' + idx).value, 10);
      if (!item || !spentBy || isNaN(amount) || amount < 1) {
        alert('Please enter valid item, spent by, and amount (>0)');
        return;
      }
      // Update the expense and re-render
      expenses[idx] = { item, spentBy, amount };
      render();
    }
    // Delete expense
    function deleteExpense(idx) {
      if (confirm('Are you sure you want to delete this expense?')) {
        expenses.splice(idx, 1);
        render();
      }
    }
    // Cancel edit expense
    function cancelEditExpense(idx) {
      delete expenses[idx].editing;
      render();
    }

    // Add donor
    document.getElementById('donor-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('donor-name').value.trim();
      const amount = parseInt(document.getElementById('donor-amount').value, 10);
      if (name && amount > 0) {
        donors.push({ name, amount });
        render();
        this.reset();
      }
    });
      // Edit donor
      function editDonor(idx) {
        donors[idx].editing = true;
        render();
      }
      // Save donor
      function saveDonor(idx) {
        const name = document.getElementById('edit-donor-name-' + idx).value.trim();
        const amount = parseInt(document.getElementById('edit-donor-amount-' + idx).value, 10);
        if (name && amount > 0) {
          donors[idx] = { name, amount };
          render();
        }
      }
      // Cancel edit donor
      function cancelEditDonor(idx) {
        delete donors[idx].editing;
        render();
      }
    // Add expense
    document.getElementById('expense-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const item = document.getElementById('expense-item').value.trim();
      const spentBy = document.getElementById('expense-spentby').value.trim();
      const amount = parseInt(document.getElementById('expense-amount').value, 10);
      if (item && spentBy && amount > 0) {
        expenses.push({ item, spentBy, amount });
        render();
        this.reset();
      }
    });
  </script>
</body>
  <footer style="text-align:center;margin:32px 0 12px 0;font-size:1em;color:#b36b00;opacity:0.92;letter-spacing:0.2px;">
    <div style="margin-bottom:4px;">
      &copy; 2025 M.D Puttur Village
      &nbsp;|&nbsp;
      Developed by Mohanbabu Padileti <span style="color:#e65100;font-size:1.1em;vertical-align:middle;">&#10084;&#65039;</span>
    </div>
  </footer>
</html>
